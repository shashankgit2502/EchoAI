<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent Builder - Professional Edition</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Notion-style seamless UI */
      --primary-bg: #ffffff;
      --secondary-bg: #ffffff;
      --tertiary-bg: #f7f7f5;
      --sidebar-bg: #f7f7f5;
      --hover-bg: rgba(0, 0, 0, 0.03);
      --accent-blue: #2383e2;
      --accent-purple: #9065b0;
      --accent-pink: #e255a1;
      --accent-green: #4dab9a;
      --accent-orange: #d9730d;
      --accent-red: #e03e3e;
      --text-primary: #37352f;
      --text-secondary: #787774;
      --text-muted: #9b9a97;
      --border-color: #e9e9e7;
      --border-light: #f1f1ef;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: rgba(15, 15, 15, 0.05) 0px 0px 0px 1px, rgba(15, 15, 15, 0.1) 0px 3px 6px, rgba(15, 15, 15, 0.2) 0px 9px 24px;
      --shadow-lg: rgba(15, 15, 15, 0.05) 0px 0px 0px 1px, rgba(15, 15, 15, 0.1) 0px 5px 10px, rgba(15, 15, 15, 0.2) 0px 15px 40px;
      --success: #4dab9a;
      --warning: #d9730d;
      --error: #e03e3e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, 'Apple Color Emoji', Arial, sans-serif;
      background: var(--primary-bg);
      color: var(--text-primary);
      overflow-x: hidden;
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-light);
      background: var(--sidebar-bg);
    }

    .sidebar-header h1 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .sidebar-header p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .agent-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .agent-card {
      padding: 10px;
      background: var(--secondary-bg);
      border: 1px solid var(--border-light);
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.1s;
    }

    .agent-card:hover {
      border-color: var(--border-color);
      box-shadow: rgba(15, 15, 15, 0.03) 0px 0px 0px 1px, rgba(15, 15, 15, 0.05) 0px 3px 6px;
    }

    .agent-card.active {
      border-color: var(--accent-blue);
      background: rgba(35, 131, 226, 0.05);
    }

    .agent-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 4px;
    }

    .agent-card-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .agent-card-role {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .agent-card-meta {
      display: flex;
      gap: 8px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .agent-card-actions {
      display: flex;
      gap: 2px;
    }

    .icon-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 3px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s;
    }

    .icon-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .sidebar-footer {
      padding: 16px;
      margin-top: auto;
    }

    .btn {
      width: 100%;
      padding: 8px 16px;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.1s;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #1a75d2;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-header {
      padding: 20px 28px;
      background: var(--secondary-bg);
      border-bottom: 1px solid var(--border-light);
    }

    .content-header h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .content-header p {
      font-size: 13px;
      color: var(--text-muted);
    }

    .content-body {
      flex: 1;
      overflow-y: auto;
      padding: 28px;
    }

    .editor-section {
      background: var(--secondary-bg);
      border: 1px solid var(--border-light);
      border-radius: 3px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .section-subtitle {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-description {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      transition: all 0.1s;
      background: var(--secondary-bg);
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: rgba(15, 15, 15, 0.05) 0px 0px 0px 1px, rgba(15, 15, 15, 0.1) 0px 3px 6px;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
      line-height: 1.5;
    }

    .form-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .range-input {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border-color);
      border-radius: 3px;
      outline: none;
    }

    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent-blue);
      border-radius: 50%;
      cursor: pointer;
    }

    .range-value {
      float: right;
      font-size: 13px;
      color: var(--accent-blue);
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 14px;
      cursor: pointer;
      color: var(--text-primary);
    }

    /* Tools Section */
    .tool-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tool-selector select {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .tool-selector button {
      padding: 8px 16px;
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 3px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.1s;
    }

    .tool-selector button:hover {
      background: #1a75d2;
    }

    .selected-tools-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .selected-tool-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--tertiary-bg);
      border: 1px solid var(--border-light);
      border-radius: 3px;
    }

    .selected-tool-info {
      flex: 1;
    }

    .selected-tool-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .selected-tool-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .selected-tool-actions {
      display: flex;
      gap: 8px;
    }

    .tool-action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tool-action-btn.configure {
      background: var(--accent-blue);
      color: white;
    }

    .tool-action-btn.remove {
      background: var(--error);
      color: white;
    }

    .no-tools-selected {
      padding: 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 13px;
      font-style: italic;
      background: var(--tertiary-bg);
      border-radius: 8px;
    }

    /* Variables */
    .variable-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }

    .variable-item {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px;
      background: var(--tertiary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .variable-name {
      min-width: 150px;
      font-size: 13px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-blue);
    }

    .variable-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 13px;
    }

    .variable-delete {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--error);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }

    .variable-delete:hover {
      background: #dc2626;
    }

    .add-variable-btn {
      padding: 10px 16px;
      background: var(--accent-green);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-variable-btn:hover {
      background: #059669;
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 12px;
      padding: 24px 32px;
      background: var(--secondary-bg);
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .action-bar .btn {
      width: auto;
      padding: 14px 24px;
    }

    .btn-secondary {
      background: var(--tertiary-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    .btn-success {
      background: var(--accent-green);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      border-left: 4px solid var(--success);
    }

    .notification.error {
      border-left: 4px solid var(--error);
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 60px;
      text-align: center;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.4;
        transform: scale(1);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    .modal {
      background: var(--secondary-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--tertiary-bg);
      border-radius: 6px;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .modal-close:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-footer .btn {
      width: auto;
      padding: 10px 20px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
      // Agent library state
      const [agents, setAgents] = useState([]);
      const [selectedAgent, setSelectedAgent] = useState(null);
      const [nextAgentId, setNextAgentId] = useState(1);

      // Agent builder form state
      const [agentName, setAgentName] = useState('');
      const [agentRole, setAgentRole] = useState('');
      const [agentGoal, setAgentGoal] = useState('');
      const [agentBackstory, setAgentBackstory] = useState('');
      const [model, setModel] = useState('gpt-4');
      const [temperature, setTemperature] = useState(0.7);
      const [maxTokens, setMaxTokens] = useState(2000);
      const [topP, setTopP] = useState(0.9);
      const [allowDelegation, setAllowDelegation] = useState(true);
      const [maxIterations, setMaxIterations] = useState(5);
      const [selectedTools, setSelectedTools] = useState([]);
      const [toolConfigs, setToolConfigs] = useState({});
      const [variables, setVariables] = useState({});

      // UI state
      const [showToolConfigModal, setShowToolConfigModal] = useState(false);
      const [configuringTool, setConfiguringTool] = useState(null);
      const [notification, setNotification] = useState(null);
      const [isEditing, setIsEditing] = useState(false);
      const [creationMode, setCreationMode] = useState('form'); // 'form' or 'prompt'
      const [userPrompt, setUserPrompt] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [showTemplates, setShowTemplates] = useState(true);
      const [chatMessages, setChatMessages] = useState([]);
      const [currentInput, setCurrentInput] = useState('');
      const [conversationStep, setConversationStep] = useState('initial'); // initial, name, refine, done
      const [suggestedName, setSuggestedName] = useState('');

      const agentTemplates = [
        {
          name: 'Career Coach',
          role: 'Career Development Advisor',
          goal: 'Provide personalized career advice and guidance',
          backstory: 'Expert career coach with years of experience helping professionals advance their careers.',
          description: 'Career Coach offers personalized career advice, resume tips, and job search strategies.',
          icon: 'üíº'
        },
        {
          name: 'Corporate Comms Crafter',
          role: 'Corporate Communications Specialist',
          goal: 'Create clear, professional corporate communications',
          backstory: 'Experienced in crafting compelling corporate messages that resonate with stakeholders.',
          description: 'The Corporate Communications Crafter is a specialist in business communication.',
          icon: 'üì¢'
        },
        {
          name: 'Customer Insights Assistant',
          role: 'Customer Analytics Expert',
          goal: 'Help teams understand customer behavior and needs',
          backstory: 'Specialist in analyzing customer data to provide actionable insights.',
          description: 'An agent designed to help the team get to know customers better.',
          icon: 'üë•'
        }
      ];

      const availableTools = [
        { 
          id: 'web_search', 
          name: 'Web Search', 
          description: 'Search the internet for information',
          requiresConfig: true,
          configFields: [
            { name: 'api_key', label: 'API Key', type: 'password', required: true },
            { name: 'search_engine', label: 'Search Engine', type: 'select', options: ['Google', 'Bing', 'DuckDuckGo'], required: true }
          ]
        },
        { 
          id: 'calculator', 
          name: 'Calculator', 
          description: 'Perform mathematical calculations',
          requiresConfig: false
        },
        { 
          id: 'file_reader', 
          name: 'File Reader', 
          description: 'Read and parse files',
          requiresConfig: false
        },
        { 
          id: 'code_executor', 
          name: 'Code Executor', 
          description: 'Execute Python code',
          requiresConfig: true,
          configFields: [
            { name: 'timeout', label: 'Timeout (seconds)', type: 'number', required: true }
          ]
        },
        { 
          id: 'email', 
          name: 'Email Tool', 
          description: 'Send emails',
          requiresConfig: true,
          configFields: [
            { name: 'smtp_server', label: 'SMTP Server', type: 'text', required: true },
            { name: 'smtp_port', label: 'SMTP Port', type: 'number', required: true },
            { name: 'username', label: 'Username', type: 'email', required: true },
            { name: 'password', label: 'Password', type: 'password', required: true }
          ]
        },
        { 
          id: 'database', 
          name: 'Database Query', 
          description: 'Query databases',
          requiresConfig: true,
          configFields: [
            { name: 'connection_string', label: 'Connection String', type: 'text', required: true }
          ]
        }
      ];

      // Load agents from localStorage on mount (shared with orchestrator)
      useEffect(() => {
        try {
          const saved = localStorage.getItem('agent_library');
          if (saved) {
            const parsedAgents = JSON.parse(saved);
            
            // Convert to object format (Edge-safe)
            const normalizedAgents = [];
            for (let i = 0; i < parsedAgents.length; i++) {
              const agent = parsedAgents[i];
              let agentVars = {};
              
              if (agent.variables) {
                if (Array.isArray(agent.variables)) {
                  // Old array format - convert
                  for (let j = 0; j < agent.variables.length; j++) {
                    const v = agent.variables[j];
                    if (v.name) {
                      agentVars[v.name] = v.value || '';
                    }
                  }
                } else {
                  agentVars = agent.variables;
                }
              }
              
              normalizedAgents.push({
                id: agent.id,
                name: agent.name,
                role: agent.role,
                goal: agent.goal,
                backstory: agent.backstory,
                model: agent.model,
                temperature: agent.temperature,
                maxTokens: agent.maxTokens,
                topP: agent.topP,
                allowDelegation: agent.allowDelegation,
                maxIterations: agent.maxIterations,
                tools: agent.tools || [],
                toolConfigs: agent.toolConfigs || {},
                variables: agentVars,
                createdAt: agent.createdAt,
                updatedAt: agent.updatedAt
              });
            }
            
            setAgents(normalizedAgents);
            
            // Set next ID
            if (normalizedAgents.length > 0) {
              let maxId = 0;
              for (let i = 0; i < normalizedAgents.length; i++) {
                const match = normalizedAgents[i].id.match(/agent-(\d+)/);
                if (match) {
                  const idNum = parseInt(match[1]);
                  if (idNum > maxId) {
                    maxId = idNum;
                  }
                }
              }
              setNextAgentId(maxId + 1);
            }
          }
        } catch (error) {
          console.error('Error loading agents:', error);
        }
      }, []);

      // Save agents to localStorage whenever they change (sync with orchestrator)
      useEffect(() => {
        try {
          localStorage.setItem('agent_library', JSON.stringify(agents));
        } catch (error) {
          console.error('Error saving agents:', error);
        }
      }, [agents]);

      const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };

      const sendChatMessage = () => {
        if (!currentInput.trim() && conversationStep !== 'initial') return;

        const messageToSend = currentInput.trim() || userPrompt.trim();
        const userMessage = { role: 'user', content: messageToSend };
        const updatedMessages = [...chatMessages, userMessage];
        setChatMessages(updatedMessages);
        setCurrentInput('');
        setUserPrompt('');
        setIsGenerating(true);

        setTimeout(() => {
          let assistantResponse = '';
          
          if (conversationStep === 'initial') {
            // First message - acknowledge and create agent
            const prompt = messageToSend.toLowerCase();
            
            // Generate agent details
            let generatedName = 'New Agent';
            let generatedRole = 'AI Assistant';
            let generatedGoal = messageToSend.trim();
            let generatedBackstory = 'An AI agent designed to help with specific tasks.';

            if (prompt.includes('research') || prompt.includes('find') || prompt.includes('stock') || prompt.includes('analyze')) {
              generatedName = 'Stock Research Advisor';
              generatedRole = 'Stock Market Research Analyst';
              generatedBackstory = 'Expert at researching stocks, performing technical and fundamental analysis.';
            } else if (prompt.includes('write') || prompt.includes('content')) {
              generatedName = 'Content Writer';
              generatedRole = 'Content Creation Specialist';
              generatedBackstory = 'Skilled writer with expertise in creating engaging content.';
            } else if (prompt.includes('data')) {
              generatedName = 'Data Analyst';
              generatedRole = 'Data Analysis Expert';
              generatedBackstory = 'Specialist in analyzing data and extracting actionable insights.';
            } else if (prompt.includes('code') || prompt.includes('develop')) {
              generatedName = 'Code Assistant';
              generatedRole = 'Software Development Expert';
              generatedBackstory = 'Experienced programmer skilled in various programming languages.';
            } else if (prompt.includes('customer') || prompt.includes('support')) {
              generatedName = 'Customer Support Agent';
              generatedRole = 'Customer Service Specialist';
              generatedBackstory = 'Dedicated to providing excellent customer support.';
            }

            // Set agent fields
            setAgentName(generatedName);
            setAgentRole(generatedRole);
            setAgentGoal(generatedGoal);
            setAgentBackstory(generatedBackstory);
            setSuggestedName(generatedName);

            assistantResponse = `Your agent has been set up to ${generatedGoal.toLowerCase()}. The agent will always base its suggestions on reputable, up-to-date sources and will explain the reasoning behind each recommendation. It will not provide personalized financial advice or guarantee investment outcomes.\n\nNext, let's choose a name for your agent. I suggest the name: ${generatedName}.\n\nWould you like to use this name, or do you have another name in mind? Please confirm your choice.`;
            
            setConversationStep('name');
          } else if (conversationStep === 'name') {
            // Handle name confirmation
            const input = messageToSend.toLowerCase();
            
            if (input.includes('yes') || input.includes('sure') || input.includes('ok') || input.includes('confirm') || input === suggestedName.toLowerCase()) {
              // Keep suggested name
              assistantResponse = `The agent's name is now set to ${suggestedName}.\n\nLet's move forward and refine what the agent will do. Could you specify any particular requirements or preferences for how the agent should work?`;
              setConversationStep('refine');
            } else {
              // User provided custom name
              setAgentName(messageToSend.trim());
              assistantResponse = `The agent's name is now set to ${messageToSend.trim()}.\n\nLet's move forward and refine what the agent will do. Could you specify any particular requirements or preferences for how the agent should work?`;
              setConversationStep('refine');
            }
          } else if (conversationStep === 'refine') {
            // Handle refinements
            const refinement = messageToSend.toLowerCase();
            
            if (refinement.includes('no') || refinement.includes('looks good') || refinement.includes('done') || refinement.includes('finish')) {
              assistantResponse = `Great! Your agent is ready. You can now:\n\n‚Ä¢ Click "Configure" tab to add tools, variables, and fine-tune settings\n‚Ä¢ Or click "üíæ Save Agent" to save as-is and start using it`;
              setConversationStep('done');
            } else {
              // Add refinement to goal or backstory
              const currentGoal = agentGoal;
              setAgentGoal(`${currentGoal}. ${messageToSend.trim()}`);
              assistantResponse = `I've updated the agent's instructions to include: "${messageToSend.trim()}"\n\nWould you like to add any other requirements, or are we ready to finalize?`;
            }
          } else {
            // Done state
            assistantResponse = `Your agent is ready! Switch to the "Configure" tab to add tools and customize further, or save the agent to start using it.`;
          }

          const botMessage = { role: 'assistant', content: assistantResponse };
          setChatMessages([...updatedMessages, botMessage]);
          setIsGenerating(false);
        }, 1000);
      };

      const useTemplate = (template) => {
        setAgentName(template.name);
        setAgentRole(template.role);
        setAgentGoal(template.goal);
        setAgentBackstory(template.backstory);
        setCreationMode('form');
        setIsEditing(true);
        showNotification(`Template applied: ${template.name}`, 'success');
      };

      const resetForm = () => {
        setAgentName('');
        setAgentRole('');
        setAgentGoal('');
        setAgentBackstory('');
        setModel('gpt-4');
        setTemperature(0.7);
        setMaxTokens(2000);
        setTopP(0.9);
        setAllowDelegation(true);
        setMaxIterations(5);
        setSelectedTools([]);
        setToolConfigs({});
        setVariables({});
      };

      const loadAgent = (agent) => {
        setSelectedAgent(agent);
        setAgentName(agent.name);
        setAgentRole(agent.role);
        setAgentGoal(agent.goal);
        setAgentBackstory(agent.backstory || '');
        setModel(agent.model);
        setTemperature(agent.temperature);
        setMaxTokens(agent.maxTokens);
        setTopP(agent.topP);
        setAllowDelegation(agent.allowDelegation);
        setMaxIterations(agent.maxIterations);
        setSelectedTools(agent.tools || []);
        setToolConfigs(agent.toolConfigs || {});
        setVariables(agent.variables || {});
        setIsEditing(true);
      };

      const saveAgent = () => {
        if (!agentName.trim() || !agentRole.trim() || !agentGoal.trim()) {
          showNotification('Please fill in required fields: Name, Role, Goal', 'error');
          return;
        }

        const agentData = {
          id: selectedAgent ? selectedAgent.id : `agent-${nextAgentId}`,
          name: agentName,
          role: agentRole,
          goal: agentGoal,
          backstory: agentBackstory,
          model: model,
          temperature: temperature,
          maxTokens: maxTokens,
          topP: topP,
          allowDelegation: allowDelegation,
          maxIterations: maxIterations,
          tools: selectedTools,
          toolConfigs: toolConfigs,
          variables: variables,
          createdAt: selectedAgent ? selectedAgent.createdAt : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };

        if (selectedAgent) {
          // Update existing - Edge-safe
          const updatedAgents = [];
          for (let i = 0; i < agents.length; i++) {
            if (agents[i].id === selectedAgent.id) {
              updatedAgents.push(agentData);
            } else {
              updatedAgents.push(agents[i]);
            }
          }
          setAgents(updatedAgents);
          showNotification(`Agent "${agentName}" updated successfully`, 'success');
        } else {
          // Create new
          setAgents([...agents, agentData]);
          setNextAgentId(nextAgentId + 1);
          showNotification(`Agent "${agentName}" created successfully`, 'success');
        }

        setSelectedAgent(agentData);
      };

      const createNewAgent = () => {
        setSelectedAgent(null);
        resetForm();
        setCreationMode('prompt');
        setIsEditing(true);
        setShowTemplates(true);
        setUserPrompt('');
        setChatMessages([]);
        setCurrentInput('');
        setConversationStep('initial');
        setSuggestedName('');
      };

      const closeEditor = () => {
        setSelectedAgent(null);
        resetForm();
        setIsEditing(false);
      };

      const deleteAgent = (agentId, e) => {
        e.stopPropagation();
        if (confirm('Are you sure you want to delete this agent?')) {
          // Edge-safe filter
          const filtered = [];
          for (let i = 0; i < agents.length; i++) {
            if (agents[i].id !== agentId) {
              filtered.push(agents[i]);
            }
          }
          setAgents(filtered);
          if (selectedAgent && selectedAgent.id === agentId) {
            resetForm();
            setSelectedAgent(null);
          }
          showNotification('Agent deleted', 'success');
        }
      };

      const duplicateAgent = (agent, e) => {
        e.stopPropagation();
        const newAgent = {
          id: `agent-${nextAgentId}`,
          name: `${agent.name} (Copy)`,
          role: agent.role,
          goal: agent.goal,
          backstory: agent.backstory,
          model: agent.model,
          temperature: agent.temperature,
          maxTokens: agent.maxTokens,
          topP: agent.topP,
          allowDelegation: agent.allowDelegation,
          maxIterations: agent.maxIterations,
          tools: agent.tools || [],
          toolConfigs: agent.toolConfigs || {},
          variables: agent.variables || {},
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        setAgents([...agents, newAgent]);
        setNextAgentId(nextAgentId + 1);
        showNotification(`Agent duplicated: ${newAgent.name}`, 'success');
      };

      const exportAgent = () => {
        if (!selectedAgent) {
          showNotification('Please select an agent first', 'error');
          return;
        }

        const exportData = {
          version: '1.0',
          agent: selectedAgent
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        const filename = `agent_${selectedAgent.name.replace(/\s+/g, '_').toLowerCase()}.json`;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification('Agent exported successfully', 'success');
      };

      const importAgentFromJSON = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              
              // Support both standalone agent and agent wrapped in object
              const agentData = data.agent || data;
              
              // Validate agent structure
              if (!agentData.name || !agentData.role || !agentData.goal) {
                throw new Error('Invalid agent format: missing required fields');
              }

              // Handle variables conversion (Edge-safe)
              let importedVars = {};
              if (agentData.variables) {
                if (Array.isArray(agentData.variables)) {
                  // Convert array [{name, value}] to object {name: value}
                  for (let i = 0; i < agentData.variables.length; i++) {
                    const v = agentData.variables[i];
                    if (v.name) {
                      importedVars[v.name] = v.value || '';
                    }
                  }
                } else if (typeof agentData.variables === 'object') {
                  importedVars = agentData.variables;
                }
              }

              // Handle tools (Edge-safe)
              let importedTools = [];
              if (agentData.tools && Array.isArray(agentData.tools)) {
                for (let i = 0; i < agentData.tools.length; i++) {
                  importedTools.push(agentData.tools[i]);
                }
              }

              // Handle toolConfigs (Edge-safe)
              let importedToolConfigs = {};
              if (agentData.toolConfigs && typeof agentData.toolConfigs === 'object') {
                const keys = Object.keys(agentData.toolConfigs);
                for (let i = 0; i < keys.length; i++) {
                  importedToolConfigs[keys[i]] = agentData.toolConfigs[keys[i]];
                }
              }

              // Create new agent with imported data
              const newAgent = {
                id: `agent-${nextAgentId}`,
                name: agentData.name,
                role: agentData.role,
                goal: agentData.goal,
                backstory: agentData.backstory || '',
                model: agentData.model || 'gpt-4',
                temperature: agentData.temperature || 0.7,
                maxTokens: agentData.maxTokens || 2000,
                topP: agentData.topP || 0.9,
                allowDelegation: agentData.allowDelegation !== undefined ? agentData.allowDelegation : true,
                maxIterations: agentData.maxIterations || 5,
                tools: importedTools,
                toolConfigs: importedToolConfigs,
                variables: importedVars,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
              };

              // Add to agents list (Edge-safe)
              const newAgents = [];
              for (let i = 0; i < agents.length; i++) {
                newAgents.push(agents[i]);
              }
              newAgents.push(newAgent);
              setAgents(newAgents);
              setNextAgentId(nextAgentId + 1);
              
              showNotification(`Agent imported: ${newAgent.name}`, 'success');
            } catch (error) {
              showNotification(`Import failed: ${error.message}`, 'error');
              console.error('Import error:', error);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      };

      const addToolToAgent = () => {
        const select = document.getElementById('tool-selector');
        const toolId = select.value;
        if (!toolId) return;

        if (!selectedTools.includes(toolId)) {
          setSelectedTools([...selectedTools, toolId]);
          select.value = '';
        }
      };

      const removeToolFromAgent = (toolId) => {
        // Edge-safe filter
        const filtered = [];
        for (let i = 0; i < selectedTools.length; i++) {
          if (selectedTools[i] !== toolId) {
            filtered.push(selectedTools[i]);
          }
        }
        setSelectedTools(filtered);
        
        // Remove config
        const newConfigs = {};
        const keys = Object.keys(toolConfigs);
        for (let i = 0; i < keys.length; i++) {
          if (keys[i] !== toolId) {
            newConfigs[keys[i]] = toolConfigs[keys[i]];
          }
        }
        setToolConfigs(newConfigs);
      };

      const openToolConfig = (tool) => {
        setConfiguringTool(tool);
        setShowToolConfigModal(true);
      };

      const saveToolConfig = () => {
        const config = {};
        const fields = configuringTool.configFields;
        
        for (let i = 0; i < fields.length; i++) {
          const field = fields[i];
          const input = document.getElementById(`config-${field.name}`);
          config[field.name] = input.value;
        }

        setToolConfigs({
          ...toolConfigs,
          [configuringTool.id]: config
        });
        
        setShowToolConfigModal(false);
        showNotification(`Configuration saved for ${configuringTool.name}`, 'success');
      };

      const addVariable = () => {
        const name = prompt('Enter variable name:');
        if (name && name.trim()) {
          setVariables({
            ...variables,
            [name.trim()]: ''
          });
        }
      };

      const updateVariable = (name, value) => {
        setVariables({
          ...variables,
          [name]: value
        });
      };

      const removeVariable = (name) => {
        const newVars = {};
        const keys = Object.keys(variables);
        for (let i = 0; i < keys.length; i++) {
          if (keys[i] !== name) {
            newVars[keys[i]] = variables[keys[i]];
          }
        }
        setVariables(newVars);
      };

      const isToolConfigured = (toolId) => {
        return toolConfigs[toolId] !== undefined;
      };

      return (
        <div className="app-container">
          {/* Sidebar */}
          <div className="sidebar">
            <div className="sidebar-header">
              <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                <a 
                  href="ai-agent-ide-dashboard.html" 
                  style={{
                    textDecoration: 'none',
                    color: 'var(--text-muted)',
                    fontSize: '14px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                    padding: '4px 8px',
                    borderRadius: '3px',
                    transition: 'all 0.1s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.target.style.background = 'var(--hover-bg)';
                    e.target.style.color = 'var(--text-primary)';
                  }}
                  onMouseLeave={(e) => {
                    e.target.style.background = 'transparent';
                    e.target.style.color = 'var(--text-muted)';
                  }}
                  title="Back to Dashboard"
                >
                  <span>‚Üê</span>
                  <span>Dashboard</span>
                </a>
              </div>
              <h1>ü§ñ AI Agent Builder</h1>
              <p>Build and manage AI agents</p>
            </div>

            <div className="sidebar-section">
              <div className="section-title">Agent Library ({agents.length})</div>
              {agents.length > 0 ? (
                <div className="agent-list">
                  {agents.map(agent => (
                    <div
                      key={agent.id}
                      className={`agent-card ${selectedAgent && selectedAgent.id === agent.id ? 'active' : ''}`}
                      onClick={() => loadAgent(agent)}
                    >
                      <div className="agent-card-header">
                        <div>
                          <div className="agent-card-name">{agent.name}</div>
                          <div className="agent-card-role">{agent.role}</div>
                        </div>
                        <div className="agent-card-actions">
                          <button
                            className="icon-btn"
                            onClick={(e) => duplicateAgent(agent, e)}
                            title="Duplicate"
                          >
                            üìã
                          </button>
                          <button
                            className="icon-btn"
                            onClick={(e) => deleteAgent(agent.id, e)}
                            title="Delete"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                      <div className="agent-card-meta">
                        <span>ü§ñ {agent.model}</span>
                        {agent.tools && agent.tools.length > 0 && (
                          <span>üõ†Ô∏è {agent.tools.length}</span>
                        )}
                        {agent.variables && Object.keys(agent.variables).length > 0 && (
                          <span>üìä {Object.keys(agent.variables).length}</span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p style={{ fontSize: '13px', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
                  No agents yet. Create one!
                </p>
              )}
            </div>

            <div className="sidebar-footer">
              <button className="btn btn-primary" onClick={createNewAgent}>
                + New Agent
              </button>
              <button className="btn btn-secondary" onClick={importAgentFromJSON} style={{ marginTop: '8px' }}>
                üì• Import JSON
              </button>
            </div>
          </div>

          {/* Main Content */}
          <div className="main-content">
            {isEditing ? (
              <>
                {creationMode === 'prompt' ? (
                  /* Prompt-based Agent Creation */
                  <>
                    <div className="content-header">
                      <h2>Create New Agent</h2>
                      <p>Describe what you want the agent to do</p>
                    </div>

                    <div className="content-body">
                      {/* Tabs */}
                      <div style={{ display: 'flex', gap: '0', borderBottom: '2px solid var(--border-color)', marginBottom: '24px' }}>
                        <div
                          style={{
                            padding: '12px 24px',
                            cursor: 'pointer',
                            borderBottom: '2px solid var(--accent-blue)',
                            color: 'var(--accent-blue)',
                            fontWeight: 600,
                            marginBottom: '-2px'
                          }}
                        >
                          Describe
                        </div>
                        <div
                          style={{
                            padding: '12px 24px',
                            cursor: 'pointer',
                            color: 'var(--text-secondary)',
                            fontWeight: 600
                          }}
                          onClick={() => setCreationMode('form')}
                        >
                          Configure
                        </div>
                      </div>

                      {/* Prompt Input */}
                      <div className="editor-section">
                        {chatMessages.length === 0 ? (
                          <>
                            <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                              <div style={{ fontSize: '14px', color: 'var(--text-primary)', marginBottom: '8px' }}>
                                Hi, I'm here to help you build an agent.
                              </div>
                              <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                You can start by describing what you want the agent to do.
                              </div>
                            </div>

                            <div className="form-group">
                              <textarea
                                className="form-textarea"
                                style={{ minHeight: '120px', fontSize: '14px' }}
                                placeholder="e.g., create an agent which does research from the web for a stock. does technical and fundamental analysis and suggest whether to buy the stock or sell or hold"
                                value={userPrompt}
                                onChange={(e) => setUserPrompt(e.target.value)}
                              />
                            </div>

                            <button
                              className="btn btn-primary"
                              onClick={() => {
                                if (userPrompt.trim()) {
                                  setShowTemplates(false);
                                  setCurrentInput(userPrompt);
                                  setUserPrompt('');
                                  sendChatMessage();
                                }
                              }}
                              disabled={isGenerating || !userPrompt.trim()}
                              style={{ width: '100%', marginTop: '0' }}
                            >
                              {isGenerating ? '‚è≥ Creating Agent...' : 'Create Agent'}
                            </button>
                          </>
                        ) : (
                          /* Chat Messages */
                          <>
                            <div style={{
                              background: 'var(--secondary-bg)',
                              border: '1px solid var(--border-color)',
                              borderRadius: '12px',
                              padding: '20px',
                              marginBottom: '16px',
                              maxHeight: '500px',
                              overflowY: 'auto'
                            }}>
                              {chatMessages.map((msg, idx) => (
                                <div key={idx} style={{ marginBottom: '20px' }}>
                                  {msg.role === 'user' ? (
                                    <div style={{
                                      background: 'rgba(79, 70, 229, 0.1)',
                                      padding: '12px 16px',
                                      borderRadius: '8px',
                                      marginLeft: '20%',
                                      fontSize: '14px',
                                      lineHeight: '1.6'
                                    }}>
                                      {msg.content}
                                    </div>
                                  ) : (
                                    <div style={{
                                      background: 'var(--tertiary-bg)',
                                      padding: '12px 16px',
                                      borderRadius: '8px',
                                      marginRight: '20%',
                                      fontSize: '14px',
                                      lineHeight: '1.6',
                                      whiteSpace: 'pre-line'
                                    }}>
                                      {msg.content}
                                    </div>
                                  )}
                                </div>
                              ))}
                              {isGenerating && (
                                <div style={{
                                  background: 'var(--tertiary-bg)',
                                  padding: '12px 16px',
                                  borderRadius: '8px',
                                  marginRight: '20%',
                                  fontSize: '14px'
                                }}>
                                  <div style={{ display: 'flex', gap: '4px', alignItems: 'center' }}>
                                    <div style={{ 
                                      width: '8px', 
                                      height: '8px', 
                                      background: 'var(--accent-blue)', 
                                      borderRadius: '50%',
                                      animation: 'pulse 1.4s ease-in-out infinite'
                                    }}></div>
                                    <div style={{ 
                                      width: '8px', 
                                      height: '8px', 
                                      background: 'var(--accent-blue)', 
                                      borderRadius: '50%',
                                      animation: 'pulse 1.4s ease-in-out 0.2s infinite'
                                    }}></div>
                                    <div style={{ 
                                      width: '8px', 
                                      height: '8px', 
                                      background: 'var(--accent-blue)', 
                                      borderRadius: '50%',
                                      animation: 'pulse 1.4s ease-in-out 0.4s infinite'
                                    }}></div>
                                  </div>
                                </div>
                              )}
                            </div>

                            {/* Chat Input */}
                            <div style={{ 
                              position: 'relative',
                              background: 'var(--secondary-bg)',
                              border: '1px solid var(--border-color)',
                              borderRadius: '12px',
                              padding: '16px'
                            }}>
                              <textarea
                                placeholder="Type your message"
                                value={currentInput}
                                onChange={(e) => setCurrentInput(e.target.value)}
                                onKeyPress={(e) => {
                                  if (e.key === 'Enter' && !e.shiftKey && !isGenerating) {
                                    e.preventDefault();
                                    sendChatMessage();
                                  }
                                }}
                                disabled={isGenerating || conversationStep === 'done'}
                                style={{ 
                                  width: '100%',
                                  border: 'none',
                                  outline: 'none',
                                  background: 'transparent',
                                  resize: 'none',
                                  minHeight: '60px',
                                  fontSize: '14px',
                                  fontFamily: 'Outfit, sans-serif',
                                  color: 'var(--text-primary)',
                                  paddingBottom: '30px'
                                }}
                                maxLength={2000}
                              />
                              <div style={{
                                position: 'absolute',
                                bottom: '16px',
                                left: '16px',
                                fontSize: '12px',
                                color: 'var(--text-muted)',
                                fontFamily: 'JetBrains Mono, monospace'
                              }}>
                                {currentInput.length}/2000
                              </div>
                              <button
                                onClick={sendChatMessage}
                                disabled={isGenerating || !currentInput.trim() || conversationStep === 'done'}
                                style={{ 
                                  position: 'absolute',
                                  bottom: '16px',
                                  right: '16px',
                                  background: 'transparent',
                                  border: 'none',
                                  cursor: isGenerating || !currentInput.trim() || conversationStep === 'done' ? 'not-allowed' : 'pointer',
                                  padding: '8px',
                                  opacity: isGenerating || !currentInput.trim() || conversationStep === 'done' ? 0.3 : 1,
                                  transition: 'opacity 0.2s'
                                }}
                              >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                              </button>
                            </div>

                            {conversationStep === 'done' && (
                              <div style={{ 
                                marginTop: '16px',
                                padding: '12px',
                                background: 'rgba(16, 185, 129, 0.1)',
                                border: '1px solid var(--success)',
                                borderRadius: '8px',
                                fontSize: '13px',
                                color: 'var(--success)',
                                textAlign: 'center'
                              }}>
                                ‚úì Agent ready! Switch to Configure tab or save now.
                              </div>
                            )}
                          </>
                        )}
                      </div>

                      {/* Templates Section */}
                      {showTemplates && (
                        <div className="editor-section">
                          <div style={{ fontSize: '14px', color: 'var(--text-primary)', marginBottom: '16px' }}>
                            Or, you can try one of the following templates.
                          </div>

                          {agentTemplates.map((template, idx) => (
                            <div
                              key={idx}
                              style={{
                                padding: '16px',
                                background: 'var(--tertiary-bg)',
                                border: '1px solid var(--border-color)',
                                borderRadius: '8px',
                                marginBottom: '12px',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                              }}
                              onMouseOver={(e) => e.currentTarget.style.borderColor = 'var(--accent-blue)'}
                              onMouseOut={(e) => e.currentTarget.style.borderColor = 'var(--border-color)'}
                              onClick={() => useTemplate(template)}
                            >
                              <div style={{ display: 'flex', alignItems: 'start', gap: '12px' }}>
                                <div style={{ fontSize: '32px' }}>{template.icon}</div>
                                <div style={{ flex: 1 }}>
                                  <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    gap: '8px',
                                    marginBottom: '6px'
                                  }}>
                                    <div style={{ fontWeight: 600, fontSize: '14px' }}>
                                      {template.name}
                                    </div>
                                    <div style={{
                                      fontSize: '10px',
                                      padding: '2px 8px',
                                      background: 'var(--accent-blue)',
                                      color: 'white',
                                      borderRadius: '4px'
                                    }}>
                                      Template
                                    </div>
                                  </div>
                                  <div style={{ 
                                    fontSize: '12px', 
                                    color: 'var(--text-secondary)',
                                    lineHeight: '1.5'
                                  }}>
                                    {template.description}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Action Bar */}
                    <div className="action-bar">
                      <button className="btn btn-secondary" onClick={closeEditor}>
                        ‚Üê Back to Library
                      </button>
                      {conversationStep === 'done' && (
                        <button className="btn btn-success" onClick={saveAgent} style={{ marginLeft: 'auto' }}>
                          üíæ Save Agent
                        </button>
                      )}
                    </div>
                  </>
                ) : (
                  /* Form-based Configuration */
                  <>
                <div className="content-header">
                  <h2>{selectedAgent ? `Edit: ${selectedAgent.name}` : 'New Agent'}</h2>
                  <p>Configure your AI agent's capabilities and behavior</p>
                </div>

                <div className="content-body">
                  {/* Tabs */}
                  <div style={{ display: 'flex', gap: '0', borderBottom: '2px solid var(--border-color)', marginBottom: '24px' }}>
                    <div
                      style={{
                        padding: '12px 24px',
                        cursor: 'pointer',
                        color: 'var(--text-secondary)',
                        fontWeight: 600
                      }}
                      onClick={() => {
                        if (!selectedAgent) {
                          setCreationMode('prompt');
                        }
                      }}
                    >
                      Describe
                    </div>
                    <div
                      style={{
                        padding: '12px 24px',
                        cursor: 'pointer',
                        borderBottom: '2px solid var(--accent-blue)',
                        color: 'var(--accent-blue)',
                        fontWeight: 600,
                        marginBottom: '-2px'
                      }}
                    >
                      Configure
                    </div>
                  </div>

                  {/* Basic Information */}
                  <div className="editor-section">
                    <div className="section-subtitle">üìù Basic Information</div>
                    <div className="section-description">
                      Define the core identity and purpose of your agent
                    </div>

                    <div className="form-group">
                      <label className="form-label">Agent Name *</label>
                      <input
                        type="text"
                        className="form-input"
                        value={agentName}
                        onChange={(e) => setAgentName(e.target.value)}
                        placeholder="e.g., Research Assistant"
                      />
                    </div>

                    <div className="form-group">
                      <label className="form-label">Role *</label>
                      <input
                        type="text"
                        className="form-input"
                        value={agentRole}
                        onChange={(e) => setAgentRole(e.target.value)}
                        placeholder="e.g., Senior Research Analyst"
                      />
                    </div>

                    <div className="form-group">
                      <label className="form-label">Goal *</label>
                      <textarea
                        className="form-textarea"
                        value={agentGoal}
                        onChange={(e) => setAgentGoal(e.target.value)}
                        placeholder="What is this agent's primary objective?"
                      />
                    </div>

                    <div className="form-group">
                      <label className="form-label">Backstory</label>
                      <textarea
                        className="form-textarea"
                        value={agentBackstory}
                        onChange={(e) => setAgentBackstory(e.target.value)}
                        placeholder="Provide context about the agent's expertise and experience"
                      />
                    </div>
                  </div>

                  {/* Tools */}
                  <div className="editor-section">
                    <div className="section-subtitle">üõ†Ô∏è Agent Tools</div>
                    <div className="section-description">
                      Equip your agent with tools to extend its capabilities
                    </div>
                    
                    <div className="tool-selector">
                      <select id="tool-selector">
                        <option value="">-- Select a tool to add --</option>
                        {availableTools
                          .filter(tool => !selectedTools.includes(tool.id))
                          .map(tool => (
                            <option key={tool.id} value={tool.id}>
                              {tool.name} {isToolConfigured(tool.id) ? '‚úì' : ''}
                            </option>
                          ))}
                      </select>
                      <button onClick={addToolToAgent}>+ Add Tool</button>
                    </div>

                    {selectedTools.length > 0 ? (
                      <div className="selected-tools-list">
                        {selectedTools.map(toolId => {
                          const tool = availableTools.find(t => t.id === toolId);
                          if (!tool) return null;
                          return (
                            <div key={toolId} className="selected-tool-item">
                              <div className="selected-tool-info">
                                <div className="selected-tool-name">
                                  {tool.name}
                                  {isToolConfigured(toolId) && (
                                    <span style={{fontSize: '10px', color: 'var(--success)', marginLeft: '6px'}}>
                                      ‚úì Configured
                                    </span>
                                  )}
                                </div>
                                <div className="selected-tool-desc">{tool.description}</div>
                              </div>
                              <div className="selected-tool-actions">
                                {tool.requiresConfig && (
                                  <button
                                    className="tool-action-btn configure"
                                    onClick={() => openToolConfig(tool)}
                                  >
                                    ‚öôÔ∏è Configure
                                  </button>
                                )}
                                <button
                                  className="tool-action-btn remove"
                                  onClick={() => removeToolFromAgent(toolId)}
                                >
                                  √ó Remove
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <div className="no-tools-selected">
                        No tools selected. Add tools using the dropdown above.
                      </div>
                    )}
                  </div>

                  {/* Variables */}
                  <div className="editor-section">
                    <div className="section-subtitle">üìä Agent Variables</div>
                    <div className="section-description">
                      Define variables/context that can be passed to this agent
                    </div>

                    {Object.keys(variables).length > 0 ? (
                      <div className="variable-list">
                        {Object.entries(variables).map(([name, value]) => (
                          <div key={name} className="variable-item">
                            <div className="variable-name">{name}</div>
                            <input
                              type="text"
                              className="variable-input"
                              value={value}
                              onChange={(e) => updateVariable(name, e.target.value)}
                              placeholder="Default value"
                            />
                            <button
                              className="variable-delete"
                              onClick={() => removeVariable(name)}
                            >
                              √ó
                            </button>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p style={{ fontSize: '13px', color: 'var(--text-secondary)', fontStyle: 'italic', marginBottom: '16px' }}>
                        No variables defined yet
                      </p>
                    )}
                    <button className="add-variable-btn" onClick={addVariable}>
                      + Add Variable
                    </button>
                  </div>

                  {/* Collaboration Settings */}
                  <div className="editor-section">
                    <div className="section-subtitle">ü§ù Collaboration Settings</div>
                    <div className="section-description">
                      Configure how this agent works with other agents
                    </div>

                    <div className="checkbox-group">
                      <input
                        type="checkbox"
                        className="checkbox"
                        id="delegation-checkbox"
                        checked={allowDelegation}
                        onChange={(e) => setAllowDelegation(e.target.checked)}
                      />
                      <label className="checkbox-label" htmlFor="delegation-checkbox">
                        Allow this agent to delegate tasks to other agents
                      </label>
                    </div>
                    <p className="form-hint">Enables multi-agent collaboration and task distribution</p>

                    <div className="form-group">
                      <label className="form-label">
                        Max Iterations
                        <span className="range-value">{maxIterations}</span>
                      </label>
                      <input
                        type="range"
                        className="range-input"
                        min="1"
                        max="20"
                        step="1"
                        value={maxIterations}
                        onChange={(e) => setMaxIterations(parseInt(e.target.value))}
                      />
                      <p className="form-hint">Maximum number of task iterations before completion</p>
                    </div>
                  </div>

                  {/* AI Configuration */}
                  <div className="editor-section">
                    <div className="section-subtitle">‚öôÔ∏è AI Configuration</div>
                    <div className="section-description">
                      Fine-tune the AI model parameters for optimal performance
                    </div>

                    <div className="form-group">
                      <label className="form-label">Model</label>
                      <select
                        className="form-select"
                        value={model}
                        onChange={(e) => setModel(e.target.value)}
                      >
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="claude-3-opus">Claude 3 Opus</option>
                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                        <option value="claude-3-haiku">Claude 3 Haiku</option>
                      </select>
                    </div>

                    <div className="form-group">
                      <label className="form-label">
                        Temperature
                        <span className="range-value">{temperature}</span>
                      </label>
                      <input
                        type="range"
                        className="range-input"
                        min="0"
                        max="2"
                        step="0.1"
                        value={temperature}
                        onChange={(e) => setTemperature(parseFloat(e.target.value))}
                      />
                      <p className="form-hint">Higher values = more creative, lower = more focused</p>
                    </div>

                    <div className="form-group">
                      <label className="form-label">
                        Max Tokens
                        <span className="range-value">{maxTokens}</span>
                      </label>
                      <input
                        type="range"
                        className="range-input"
                        min="100"
                        max="8000"
                        step="100"
                        value={maxTokens}
                        onChange={(e) => setMaxTokens(parseInt(e.target.value))}
                      />
                      <p className="form-hint">Maximum response length</p>
                    </div>

                    <div className="form-group">
                      <label className="form-label">
                        Top P
                        <span className="range-value">{topP}</span>
                      </label>
                      <input
                        type="range"
                        className="range-input"
                        min="0"
                        max="1"
                        step="0.05"
                        value={topP}
                        onChange={(e) => setTopP(parseFloat(e.target.value))}
                      />
                      <p className="form-hint">Nucleus sampling threshold</p>
                    </div>
                  </div>
                </div>

                {/* Action Bar */}
                <div className="action-bar">
                  <button className="btn btn-secondary" onClick={closeEditor}>
                    ‚Üê Back to Library
                  </button>
                  <button className="btn btn-secondary" onClick={exportAgent}>
                    üì§ Export
                  </button>
                  <button className="btn btn-success" onClick={saveAgent}>
                    üíæ {selectedAgent ? 'Update' : 'Save'} Agent
                  </button>
                </div>
              </>
                )}
              </>
            ) : (
              <div className="empty-state">
                <div className="empty-state-icon">ü§ñ</div>
                <div className="empty-state-title">Welcome to Agent Builder</div>
                <div className="empty-state-text">
                  Create a new agent or select one from the library to get started
                </div>
                <button className="btn btn-primary" onClick={createNewAgent} style={{ width: 'auto' }}>
                  + Create Your First Agent
                </button>
              </div>
            )}
          </div>

          {/* Tool Config Modal */}
          {showToolConfigModal && configuringTool && (
            <div className="modal-overlay" onClick={() => setShowToolConfigModal(false)}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <div className="modal-title">Configure: {configuringTool.name}</div>
                  <button className="modal-close" onClick={() => setShowToolConfigModal(false)}>
                    √ó
                  </button>
                </div>
                <div className="modal-body">
                  <p style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '20px' }}>
                    {configuringTool.description}
                  </p>
                  {configuringTool.configFields.map(field => (
                    <div key={field.name} className="form-group">
                      <label className="form-label">
                        {field.label} {field.required && '*'}
                      </label>
                      {field.type === 'select' ? (
                        <select
                          id={`config-${field.name}`}
                          className="form-select"
                          defaultValue={toolConfigs[configuringTool.id]?.[field.name] || ''}
                        >
                          <option value="">-- Select --</option>
                          {field.options.map(opt => (
                            <option key={opt} value={opt}>{opt}</option>
                          ))}
                        </select>
                      ) : (
                        <input
                          type={field.type}
                          id={`config-${field.name}`}
                          className="form-input"
                          defaultValue={toolConfigs[configuringTool.id]?.[field.name] || ''}
                        />
                      )}
                    </div>
                  ))}
                </div>
                <div className="modal-footer">
                  <button className="btn btn-secondary" onClick={() => setShowToolConfigModal(false)}>
                    Cancel
                  </button>
                  <button className="btn btn-primary" onClick={saveToolConfig}>
                    Save Configuration
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Notification */}
          {notification && (
            <div className={`notification ${notification.type}`}>
              {notification.message}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>